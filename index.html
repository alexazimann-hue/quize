<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Familial Interactif</title>
    <!-- Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React et ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel pour transformer le JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Fonction de r√©cup√©ration ultra-robuste de la configuration
        const getFirebaseConfig = () => {
            const config = window.__firebase_config || (typeof __firebase_config !== 'undefined' ? __firebase_config : null);
            if (!config) return null;
            return typeof config === 'string' ? JSON.parse(config) : config;
        };

        const config = getFirebaseConfig();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'quiz-familial-prod';

        // Initialisation s√©curis√©e hors du composant pour √©viter les re-rendus
        let app, auth, db;
        if (config && config.apiKey) {
            try {
                app = getApps().length > 0 ? getApp() : initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Erreur d'initialisation Firebase:", e);
            }
        }

        const { useState, useEffect } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                trophy: <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6m12 5h1.5a2.5 2.5 0 0 0 0-5H18M12 22v-4m-7-2 2-2h10l2 2m-13-8v8a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V6H5z"/>,
                users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2m7-10a4 4 0 1 0 0-8 4 4 0 0 0 0 8m13 10v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"/>,
                "plus-circle": <><circle cx="12" cy="12" r="10"/><path d="M12 8v8m-4-4h8"/></>,
                "log-in": <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>,
                "x-circle": <><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6m0-6 6 6"/></>,
                play: <polygon points="5 3 19 12 5 21 5 3"/>,
                "check-circle": <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        const QUIZ_DATA = [
            { id: 1, category: 'G√©ographie', question: "Quel est le plus petit pays du monde ?", options: ["Monaco", "Le Vatican", "Saint-Marin", "Andorre"], response: "Le Vatican" },
            { id: 2, category: 'Gastronomie', question: "Quel ingr√©dient est √† la base du chocolat ?", options: ["Le caf√©", "La vanille", "Le cacao", "Le sucre"], response: "Le cacao" },
            { id: 3, category: 'Logique', question: "Si j'ai 3 pommes et que tu m'en prends 2, combien de pommes as-tu ?", options: ["1 pomme", "2 pommes", "3 pommes", "Aucune"], response: "2 pommes" },
            { id: 4, category: 'Devinette', question: "Qu'est-ce que tout le monde poss√®de mais que les autres utilisent plus que vous ?", options: ["Votre voiture", "Votre argent", "Votre pr√©nom", "Votre temps"], response: "Votre pr√©nom" }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [authReady, setAuthReady] = useState(false);
            const [gameState, setGameState] = useState(null);
            const [view, setView] = useState('lobby');
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [showResult, setShowResult] = useState(false);
            const [availableGames, setAvailableGames] = useState([]);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!auth) {
                    setError("Impossible de charger la configuration du jeu.");
                    return;
                }

                const performAuth = async () => {
                    try {
                        // On attend un cycle pour √™tre s√ªr que tout est pr√™t
                        await new Promise(res => setTimeout(res, 300));

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Fail:", err);
                        // On force un retry anonyme si le token √©choue
                        try { await signInAnonymously(auth); } 
                        catch (e) { setError("La connexion au serveur a √©chou√©."); }
                    }
                };

                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        setAuthReady(true);
                    } else {
                        performAuth();
                    }
                });

                return () => unsubscribe();
            }, []);

            // Chargement des sessions
            useEffect(() => {
                if (!authReady || !user || !db || view !== 'lobby') return;
                
                try {
                    const sessionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'sessions');
                    const unsubscribe = onSnapshot(sessionsRef, (snapshot) => {
                        const games = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setAvailableGames(games.filter(g => g.status !== 'finished'));
                    }, (err) => {
                        console.error("Snapshot error:", err);
                    });
                    return () => unsubscribe();
                } catch (e) { console.error(e); }
            }, [authReady, user, view]);

            // Sync de la partie
            useEffect(() => {
                if (!authReady || !user || !db || view === 'lobby' || !gameState?.id) return;
                
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', gameState.id);
                const unsubscribe = onSnapshot(gameDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setGameState(prev => ({ ...prev, ...data }));
                        if (data.status === 'playing' && view === 'waiting') setView('playing');
                        if (gameState && data.currentQuestionIndex !== gameState.currentQuestionIndex) {
                            setSelectedAnswer(null);
                            setShowResult(false);
                        }
                    } else {
                        setView('lobby');
                    }
                });
                return () => unsubscribe();
            }, [authReady, user, view, gameState?.id]);

            const createGame = async () => {
                if (!db || !user) return;
                const gameId = `session_${Math.random().toString(36).substring(2, 7)}`;
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', gameId);
                const newGame = { 
                    id: gameId, 
                    status: 'waiting', 
                    currentQuestionIndex: 0, 
                    adminId: user.uid, 
                    players: [user.uid], 
                    createdAt: Date.now() 
                };
                await setDoc(gameDocRef, newGame);
                setGameState(newGame);
                setView('waiting');
            };

            const joinGame = async (game) => {
                if (!db || !user) return;
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', game.id);
                await updateDoc(gameDocRef, { players: arrayUnion(user.uid) });
                setGameState(game);
                setView(game.status === 'playing' ? 'playing' : 'waiting');
            };

            const launchGame = async () => {
                if (!gameState || !db) return;
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', gameState.id);
                await updateDoc(gameDocRef, { status: 'playing' });
            };

            const handleAnswerSelect = (option) => {
                if (showResult) return;
                setSelectedAnswer(option);
                setShowResult(true);
            };

            const nextQuestion = async () => {
                if (!gameState || !db) return;
                const nextIndex = gameState.currentQuestionIndex + 1;
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', gameState.id);
                if (nextIndex < QUIZ_DATA.length) {
                    await updateDoc(gameDocRef, { currentQuestionIndex: nextIndex });
                } else {
                    await updateDoc(gameDocRef, { status: 'finished' });
                }
            };

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6">
                        <div className="bg-white p-8 rounded-3xl shadow-xl border border-red-100 text-center max-w-sm">
                            <Icon name="x-circle" size={48} className="text-red-500 mx-auto mb-4" />
                            <h2 className="text-xl font-bold text-slate-800 mb-2">Erreur Fatale</h2>
                            <p className="text-slate-500 text-sm mb-6">{error}</p>
                            <button onClick={() => window.location.reload()} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">R√©essayer</button>
                        </div>
                    </div>
                );
            }

            if (!authReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-slate-400 font-medium animate-pulse">Initialisation s√©curis√©e...</p>
                        </div>
                    </div>
                );
            }

            if (view === 'lobby') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl p-8 text-center border">
                            <div className="bg-indigo-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-lg shadow-indigo-200">
                                <Icon name="trophy" size={40} className="text-white" />
                            </div>
                            <h1 className="text-4xl font-black mb-2 text-slate-800 tracking-tight">Quiz Family</h1>
                            <p className="text-slate-400 mb-10">Pr√™t √† tester vos connaissances ?</p>
                            
                            <button onClick={createGame} className="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-xl mb-10 flex items-center justify-center gap-3 hover:bg-indigo-700 transition-all active:scale-95">
                                <Icon name="plus-circle" /> CR√âER UN SALON
                            </button>

                            <div className="text-left">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-ping"></span>
                                    Salons en ligne
                                </h3>
                                <div className="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                    {availableGames.length > 0 ? availableGames.map(game => (
                                        <button key={game.id} onClick={() => joinGame(game)} className="w-full bg-slate-50 border border-slate-100 p-5 rounded-2xl flex items-center justify-between hover:border-indigo-500 hover:bg-white transition-all group">
                                            <div className="flex items-center gap-4">
                                                <div className="w-10 h-10 rounded-xl bg-white border flex items-center justify-center text-lg">üéÆ</div>
                                                <div className="text-left">
                                                    <p className="font-bold text-slate-700">Salon {game.id.split('_')[1]}</p>
                                                    <p className="text-[10px] text-slate-400 font-bold">{game.players?.length || 0} JOUEURS</p>
                                                </div>
                                            </div>
                                            <Icon name="log-in" className="text-slate-300 group-hover:text-indigo-600" />
                                        </button>
                                    )) : (
                                        <div className="py-8 border-2 border-dashed border-slate-100 rounded-2xl text-slate-300 text-sm font-medium">
                                            Aucun salon actif pour le moment
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'waiting') {
                const isAdmin = gameState?.adminId === user?.uid;
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl p-10 text-center">
                            <h2 className="text-2xl font-black mb-8">En attente des joueurs</h2>
                            <div className="bg-indigo-50 border-2 border-indigo-100 p-8 rounded-3xl mb-8 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="users" size={80} /></div>
                                <p className="text-xs font-black text-indigo-400 uppercase tracking-widest mb-2">Code d'acc√®s</p>
                                <p className="text-4xl font-black text-indigo-600 tracking-[0.2em]">{gameState?.id.split('_')[1]?.toUpperCase()}</p>
                            </div>
                            <div className="mb-10 text-left">
                                <p className="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">√âquipe ({gameState?.players?.length || 0})</p>
                                <div className="flex flex-wrap gap-2">
                                    {gameState?.players?.map((p, i) => (
                                        <div key={i} className="bg-white border-2 border-slate-100 px-4 py-2 rounded-xl flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full bg-indigo-500"></div>
                                            <span className="font-bold text-slate-600 text-sm">Joueur {p.slice(-4)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            {isAdmin ? (
                                <button onClick={launchGame} className="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-xl flex items-center justify-center gap-3 hover:bg-indigo-700 transition-all active:scale-95">
                                    <Icon name="play" /> D√âMARRER LA PARTIE
                                </button>
                            ) : (
                                <div className="bg-slate-50 text-slate-400 p-5 rounded-2xl font-bold border border-slate-100 italic">
                                    L'organisateur va lancer le quiz...
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (gameState?.status === 'finished') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl p-10 text-center border">
                            <div className="text-6xl mb-6 animate-bounce">üèÜ</div>
                            <h2 className="text-3xl font-black mb-4">Bravo !</h2>
                            <p className="text-slate-500 mb-10 leading-relaxed">La partie est termin√©e. Merci d'avoir jou√© au Quiz Family !</p>
                            <button onClick={() => setView('lobby')} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-lg">RETOUR AU SALON</button>
                        </div>
                    </div>
                );
            }

            const currentQ = QUIZ_DATA[gameState?.currentQuestionIndex || 0];
            const isAdmin = gameState?.adminId === user?.uid;

            return (
                <div className="min-h-screen p-4 md:p-10 flex flex-col items-center bg-slate-50">
                    <div className="max-w-2xl w-full">
                        <div className="flex justify-between items-end mb-8 px-4">
                            <div>
                                <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Session active</h4>
                                <div className="flex items-center gap-3">
                                    <div className={`w-3 h-3 rounded-full ${isAdmin ? 'bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.5)]' : 'bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.5)]'}`}></div>
                                    <span className="font-black text-slate-800 text-sm tracking-tight">{isAdmin ? "ORGANISATEUR" : "JOUEUR"}</span>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Progression</p>
                                <p className="font-black text-indigo-600 text-lg">{(gameState?.currentQuestionIndex || 0) + 1} / {QUIZ_DATA.length}</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-white">
                            <div className="h-3 w-full bg-slate-100">
                                <div className="h-full bg-indigo-600 transition-all duration-700 ease-out" style={{width: `${((gameState?.currentQuestionIndex || 0) + 1) / QUIZ_DATA.length * 100}%`}}></div>
                            </div>
                            <div className="p-8 md:p-16">
                                <div className="inline-block bg-indigo-50 text-indigo-600 px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.2em] mb-8 border border-indigo-100">
                                    {currentQ?.category}
                                </div>
                                <h2 className="text-3xl md:text-4xl font-black text-slate-800 mb-12 leading-tight tracking-tight">{currentQ?.question}</h2>
                                <div className="grid grid-cols-1 gap-4">
                                    {currentQ?.options.map((opt, i) => {
                                        const isCorrect = opt === currentQ.response;
                                        const isSelected = selectedAnswer === opt;
                                        let style = "bg-slate-50 border-2 border-slate-50 text-slate-700 hover:bg-white hover:border-indigo-100 hover:shadow-md";
                                        
                                        if (showResult) {
                                            if (isCorrect) style = "bg-emerald-50 border-emerald-500 text-emerald-800 ring-8 ring-emerald-50 scale-[1.02] shadow-xl";
                                            else if (isSelected) style = "bg-red-50 border-red-200 text-red-800 opacity-60";
                                            else style = "opacity-30 grayscale-[0.5]";
                                        } else if (isSelected) {
                                            style = "bg-indigo-50 border-indigo-600 text-indigo-800 ring-8 ring-indigo-50 shadow-lg";
                                        }

                                        return (
                                            <button 
                                                key={i} 
                                                disabled={showResult} 
                                                onClick={() => handleAnswerSelect(opt)} 
                                                className={`p-7 rounded-[1.5rem] font-black transition-all text-left flex justify-between items-center text-lg ${style}`}
                                            >
                                                {opt}
                                                {showResult && isCorrect && <Icon name="check-circle" className="text-emerald-500" size={24} />}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            {isAdmin && showResult && (
                                <div className="p-10 bg-slate-50/50 border-t border-slate-100 flex justify-center">
                                    <button onClick={nextQuestion} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-2xl hover:bg-black transition-all active:scale-95 flex items-center justify-center gap-3">
                                        {(gameState?.currentQuestionIndex || 0) === QUIZ_DATA.length - 1 ? "VOIR LE CLASSEMENT" : "QUESTION SUIVANTE"}
                                        <Icon name="play" size={16} />
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</body>
</html>
