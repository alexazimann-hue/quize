<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Familial Interactif</title>
    <!-- Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React et ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel pour transformer le JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteDoc, collection, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Configuration Firebase
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'quiz-familial-prod';

        const { useState, useEffect, useCallback } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const QUIZ_DATA = [
            { id: 1, type: 'Culture', category: 'GÃ©ographie', question: "Quel est le plus petit pays du monde ?", options: ["Monaco", "Le Vatican", "Saint-Marin", "Andorre"], response: "Le Vatican" },
            { id: 2, type: 'Culture', category: 'Gastronomie', question: "Quel ingrÃ©dient est Ã  la base du chocolat ?", options: ["Le cafÃ©", "La vanille", "Le cacao", "Le sucre"], response: "Le cacao" },
            { id: 3, type: 'Logique', category: 'Chiffres', question: "Si j'ai 3 pommes et que tu m'en prends 2, combien de pommes as-tu ?", options: ["1 pomme", "2 pommes", "3 pommes", "Aucune"], response: "2 pommes" },
            { id: 4, type: 'Logique', category: 'Devinette', question: "Qu'est-ce que tout le monde possÃ¨de mais que les autres utilisent plus que vous ?", options: ["Votre voiture", "Votre argent", "Votre prÃ©nom", "Votre temps"], response: "Votre prÃ©nom" }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [authReady, setAuthReady] = useState(false);
            const [gameState, setGameState] = useState(null);
            const [view, setView] = useState('lobby');
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [showResult, setShowResult] = useState(false);
            const [availableGames, setAvailableGames] = useState([]);

            // 1. Initialisation de l'Auth (Strict Rule 3)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Erreur d'authentification:", err);
                    }
                };

                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        setAuthReady(true);
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. Ã‰couteur Lobby (ConditionnÃ© par authReady)
            useEffect(() => {
                if (!authReady || !user || view !== 'lobby') return;
                
                const sessionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'sessions');
                const unsubscribe = onSnapshot(sessionsRef, (snapshot) => {
                    const games = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAvailableGames(games.filter(g => g.status === 'waiting' || g.status === 'playing'));
                }, (error) => {
                    console.error("Firestore Lobby Error:", error);
                });
                
                return () => unsubscribe();
            }, [authReady, user, view]);

            // 3. Ã‰couteur Session Active
            useEffect(() => {
                if (!authReady || !user || view === 'lobby' || !gameState?.id) return;
                
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', gameState.id);
                const unsubscribe = onSnapshot(gameDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setGameState(prev => ({ ...prev, ...data }));
                        
                        if (data.status === 'playing' && view === 'waiting') setView('playing');
                        
                        if (gameState && data.currentQuestionIndex !== gameState.currentQuestionIndex) {
                            setSelectedAnswer(null);
                            setShowResult(false);
                        }
                    } else {
                        setView('lobby');
                        setGameState(null);
                    }
                }, (error) => {
                    console.error("Game Sync Error:", error);
                });
                
                return () => unsubscribe();
            }, [authReady, user, view, gameState?.id]);

            const createGame = async () => {
                if (!authReady || !user) return;
                const gameId = `game_${user.uid.slice(0, 5)}`;
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', gameId);
                const newGame = { 
                    id: gameId, 
                    status: 'waiting', 
                    currentQuestionIndex: 0, 
                    adminId: user.uid, 
                    players: [user.uid], 
                    createdAt: Date.now() 
                };
                try {
                    await setDoc(gameDocRef, newGame);
                    setGameState(newGame);
                    setView('waiting');
                } catch (e) { console.error("Create Error:", e); }
            };

            const joinGame = async (game) => {
                if (!authReady || !user) return;
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', game.id);
                try {
                    await updateDoc(gameDocRef, { players: arrayUnion(user.uid) });
                    setGameState(game);
                    setView(game.status === 'playing' ? 'playing' : 'waiting');
                } catch (e) { console.error("Join Error:", e); }
            };

            const launchGame = async () => {
                if (!gameState || !user) return;
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', gameState.id);
                await updateDoc(gameDocRef, { status: 'playing' });
                setView('playing');
            };

            const handleAnswerSelect = (option) => {
                if (showResult) return;
                setSelectedAnswer(option);
                setShowResult(true);
            };

            const nextQuestion = async () => {
                if (!gameState) return;
                const nextIndex = gameState.currentQuestionIndex + 1;
                const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', gameState.id);
                if (nextIndex < QUIZ_DATA.length) {
                    await updateDoc(gameDocRef, { currentQuestionIndex: nextIndex });
                } else {
                    await updateDoc(gameDocRef, { status: 'finished' });
                }
            };

            if (!authReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50">
                        <div className="flex flex-col items-center gap-4">
                            <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                            <p className="text-slate-500 font-medium">Connexion en cours...</p>
                        </div>
                    </div>
                );
            }

            if (view === 'lobby') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-3xl shadow-xl p-8 text-center border">
                            <div className="bg-indigo-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6">
                                <Icon name="trophy" className="text-indigo-600" size={32} />
                            </div>
                            <h1 className="text-3xl font-bold mb-6 text-slate-800">Quiz Familial</h1>
                            <button 
                                onClick={createGame} 
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg mb-8 flex items-center justify-center gap-2 transition-transform active:scale-95"
                            >
                                <Icon name="plus-circle" /> CrÃ©er une partie
                            </button>
                            <div className="text-left space-y-3">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Salons actifs</p>
                                {availableGames.length > 0 ? availableGames.map(game => (
                                    <button key={game.id} onClick={() => joinGame(game)} className="w-full border p-4 rounded-xl flex items-center justify-between hover:border-indigo-500 transition-all group">
                                        <div className="flex items-center gap-3">
                                            <Icon name="users" className="text-slate-400 group-hover:text-indigo-600" />
                                            <span className="font-bold text-slate-700">Salon de {game.id.split('_')[1]}</span>
                                        </div>
                                        <Icon name="log-in" className="text-slate-300 group-hover:text-indigo-600" />
                                    </button>
                                )) : <p className="text-slate-400 text-sm italic">Aucune partie disponible...</p>}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'waiting') {
                const isAdmin = gameState?.adminId === user?.uid;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href)}`;
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-3xl shadow-xl p-8 text-center">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold">Salle d'attente</h2>
                                <button onClick={() => setView('lobby')} className="text-slate-400"><Icon name="x-circle" /></button>
                            </div>
                            <div className="bg-slate-50 p-6 rounded-2xl mb-6">
                                <img src={qrUrl} className="mx-auto w-40 h-40 mb-4 border-4 border-white shadow-sm" alt="QR Code" />
                                <p className="text-sm text-slate-500">Scannez pour rejoindre</p>
                            </div>
                            <div className="flex flex-wrap gap-2 mb-8 justify-center">
                                {gameState?.players?.map((p, i) => (
                                    <span key={i} className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">Joueur {p.slice(0,4)}</span>
                                ))}
                            </div>
                            {isAdmin ? (
                                <button onClick={launchGame} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2">
                                    <Icon name="play" /> Lancer le Quiz
                                </button>
                            ) : (
                                <p className="text-indigo-600 font-bold animate-pulse">L'admin va bientÃ´t lancer la partie...</p>
                            )}
                        </div>
                    </div>
                );
            }

            if (gameState?.status === 'finished') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-3xl shadow-xl p-8 text-center border">
                            <Icon name="trophy" size={60} className="text-yellow-500 mx-auto mb-4" />
                            <h2 className="text-2xl font-bold mb-4">Quiz terminÃ© !</h2>
                            <button onClick={() => setView('lobby')} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Menu principal</button>
                        </div>
                    </div>
                );
            }

            const currentQ = QUIZ_DATA[gameState?.currentQuestionIndex || 0];
            const isAdmin = gameState?.adminId === user?.uid;

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border mb-6 flex justify-between items-center">
                            <div className="flex items-center gap-2 font-bold text-slate-800">
                                <Icon name="users" className="text-indigo-600" />
                                {isAdmin ? "ðŸ‘‘ Admin" : "ðŸ‘¤ Joueur"}
                            </div>
                            <div className="text-sm font-bold text-slate-400">Question {(gameState?.currentQuestionIndex || 0) + 1}/{QUIZ_DATA.length}</div>
                        </div>

                        <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden border">
                            <div className="bg-indigo-600 p-6 text-white font-bold uppercase tracking-widest text-xs">
                                {currentQ?.category}
                            </div>
                            <div className="p-8 md:p-12 text-center">
                                <h2 className="text-2xl font-bold mb-10 text-slate-800">{currentQ?.question}</h2>
                                <div className="grid grid-cols-1 gap-4">
                                    {currentQ?.options.map((opt, i) => {
                                        const isCorrect = opt === currentQ.response;
                                        const isSelected = selectedAnswer === opt;
                                        let style = "bg-slate-50 border-2 border-slate-100 text-slate-700 hover:border-indigo-200";
                                        if (showResult) {
                                            if (isCorrect) style = "bg-emerald-50 border-emerald-500 text-emerald-700 ring-4 ring-emerald-100";
                                            else if (isSelected) style = "bg-red-50 border-red-500 text-red-700";
                                            else style = "opacity-40 bg-slate-50 border-slate-100 text-slate-300";
                                        } else if (isSelected) style = "bg-indigo-50 border-indigo-500 text-indigo-700";

                                        return (
                                            <button key={i} disabled={showResult} onClick={() => handleAnswerSelect(opt)} className={`p-5 rounded-2xl font-bold transition-all text-left flex justify-between items-center ${style}`}>
                                                {opt}
                                                {showResult && isCorrect && <Icon name="check-circle" className="text-emerald-500" />}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            {isAdmin && showResult && (
                                <div className="p-6 bg-slate-50 border-t flex justify-center">
                                    <button onClick={nextQuestion} className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg">
                                        {(gameState?.currentQuestionIndex || 0) === QUIZ_DATA.length - 1 ? "Terminer" : "Suivant â†’"}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
