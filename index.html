<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Familial Interactif - 100 Questions</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    [v-cloak] { display: none; }
    .animate-pop {
      animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      animation-duration: 0.4s;
    }
    @keyframes pop {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    
    /* Animation de clic sur les boutons */
    .btn-press:active { transform: scale(0.98); }
    .option-btn { transition: all 0.2s ease; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">
  <div id="app" v-cloak class="max-w-2xl mx-auto p-4 md:pt-10">
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
      <!-- Barre de progression -->
      <div class="h-3 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 w-full"></div>

      <!-- 1. CHARGEMENT INITIAL -->
      <div v-if="loading" class="p-20 text-center">
        <div class="animate-spin inline-block w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full mb-6"></div>
        <p class="text-slate-400 font-black uppercase tracking-widest text-sm text-indigo-600">Connexion...</p>
      </div>

      <!-- 2. ACCUEIL -->
      <div v-else-if="!role" class="p-8 md:p-12 text-center animate-pop">
        <div class="w-20 h-20 bg-indigo-100 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-lg">
          <i data-lucide="trophy" class="w-10 h-10 text-indigo-600"></i>
        </div>
        <h1 class="text-4xl font-black mb-2 text-slate-900">Quiz Family</h1>
        <p class="text-slate-500 mb-10 italic">100+ questions disponibles !</p>

        <!-- Cr√©er partie (Admin) -->
        <div class="space-y-6">
          <input 
            ref="nameInput" 
            v-model="tempName" 
            placeholder="Ton Pr√©nom" 
            class="w-full p-4 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-400 text-center font-bold text-lg bg-slate-50 transition-all shadow-inner"
          >
          <button 
            @click="initAdmin" 
            :disabled="!tempName"
            class="btn-press w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg hover:bg-indigo-700 transition-all shadow-xl disabled:opacity-50 flex items-center justify-center gap-3"
          >
            <i data-lucide="crown" class="w-6 h-6"></i>
            Cr√©er la partie
          </button>
        </div>

        <div class="flex items-center gap-4 py-2">
          <div class="flex-grow border-t-2 border-slate-100"></div>
          <span class="text-[10px] text-slate-300 uppercase font-black tracking-widest">REJOINDRE</span>
          <div class="flex-grow border-t-2 border-slate-100"></div>
        </div>

        <!-- Rejoindre partie (Joueur) -->
        <div class="space-y-3">
          <input 
            v-model="tempId" 
            placeholder="Code Session" 
            class="w-full p-4 border-2 border-slate-100 rounded-2xl outline-none focus:border-indigo-400 text-center uppercase font-black text-xl bg-slate-50 tracking-widest shadow-inner"
          >
          <p v-if="errorMessage" class="text-red-500 text-xs font-bold">{{ errorMessage }}</p>
          <button 
            @click="joinGame" 
            :disabled="!tempName || !tempId"
            class="btn-press w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-lg hover:bg-slate-800 transition-all disabled:opacity-50"
          >
            Rejoindre la partie
          </button>
        </div>
      </div>

      <!-- 3. SALON D'ATTENTE (LOBBY) -->
      <div v-else-if="session && session.status === 'lobby'" class="p-8 text-center animate-pop">
        <h2 class="text-2xl font-black mb-2 text-slate-900">Pr√©paration de la partie</h2>
        <p class="text-indigo-500 font-bold mb-10">
          Tu es dans la partie de <span class="underline">{{ session.adminName }}</span> (Admin)
        </p>

        <div class="flex flex-col md:flex-row gap-10 items-center justify-center mb-12">
          <!-- QR Code -->
          <div class="bg-white p-6 rounded-2rem shadow-xl border-4 border-slate-50 flex flex-col items-center">
            <div id="qrcode" class="mb-6 bg-white p-2 border border-slate-100 min-h-[128px] min-w-[128px] flex items-center justify-center"></div>
            <div class="px-8 py-3 bg-indigo-50 rounded-2xl font-black text-3xl text-indigo-600 tracking-widest uppercase">{{ session.id }}</div>
          </div>

          <!-- Liste Joueurs -->
          <div class="flex-1 w-full text-left bg-slate-50 p-6 rounded-3xl border border-slate-100">
            <p class="text-xs font-black uppercase text-slate-400 tracking-widest mb-6 flex items-center gap-2">
              <i data-lucide="users" class="w-4 h-4"></i>
              Joueurs ({{ players.length }})
            </p>
            <div class="grid grid-cols-1 gap-2 max-h-56 overflow-y-auto pr-2 custom-scrollbar">
              <div 
                v-for="p in players" 
                :key="p.id" 
                class="p-3 bg-white rounded-2xl border border-slate-200 font-bold flex items-center justify-between shadow-sm animate-pop"
              >
                <div class="flex items-center gap-3">
                  <div :class="getPlayerColor(p.name)" class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-black uppercase shadow-sm">
                    {{ p.name.charAt(0) }}
                  </div>
                  <span>{{ p.name }}</span>
                </div>
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
              </div>
            </div>
          </div>
        </div>

        <div v-if="role === 'admin'" class="space-y-4">
          <button 
            @click="updateStatus('playing')" 
            :disabled="players.length === 0"
            class="btn-press w-full py-6 bg-indigo-600 text-white rounded-2xl font-black text-2xl shadow-xl hover:bg-indigo-700 disabled:opacity-50"
          >
            üöÄ LANCER LE QUIZ !
          </button>
        </div>
        <div v-else class="p-8 bg-indigo-50 text-indigo-600 rounded-2rem font-black text-xl animate-pulse">
          Attente du lancement...
        </div>
      </div>

      <!-- 4. EN JEU -->
      <div v-else-if="session && session.status === 'playing' && !isWaitingForBlock" class="p-6 md:p-12 animate-pop">
        <!-- Warning si arrive en cours -->
        <div 
          v-if="role === 'player' && playerLocalIndex > session.currentBlock * 5" 
          class="bg-amber-50 text-amber-700 p-3 rounded-xl text-[10px] font-bold mb-4 flex items-center gap-2"
        >
          <i data-lucide="alert-circle" class="w-3 h-3"></i>
          Tu arrives en cours de route !
        </div>

        <div class="flex justify-between items-center mb-8">
          <div class="px-4 py-2 bg-slate-100 rounded-xl text-[11px] font-black text-slate-500 uppercase tracking-tighter">
            Question {{ playerLocalIndex + 1 }}/15
          </div>
          <div class="flex items-center gap-2">
            <div :class="getPlayerColor(name)" class="w-6 h-6 rounded-full flex items-center justify-center text-white text-[10px] uppercase shadow-sm">
              {{ name.charAt(0) }}
            </div>
            <span class="text-sm font-black text-indigo-600">{{ name }}</span>
          </div>
        </div>

        <h2 class="text-2xl md:text-3xl font-black mb-8 text-slate-900 leading-tight">
          {{ currentQuestion.question }}
        </h2>

        <!-- Support Images URL et Emojis -->
        <div v-if="currentQuestion.image" class="mb-8 p-6 bg-slate-50 rounded-[2.5rem] text-center border-2 border-slate-100 shadow-inner overflow-hidden flex items-center justify-center min-h-[160px]">
          <img 
            v-if="isImageUrl(currentQuestion.image)" 
            :src="currentQuestion.image" 
            class="max-h-48 rounded-2xl object-contain shadow-md mx-auto"
            @error="e.target.src = 'https://placehold.co/400x300?text=Image+Non+Disponible'"
          >
          <div v-else class="text-7xl p-6">{{ currentQuestion.image }}</div>
        </div>

        <div class="grid gap-3 mb-8">
          <button 
            v-for="(opt, idx) in currentQuestion.options" 
            :key="idx" 
            :disabled="hasValidated" 
            @click="selectedIdx = idx"
            :class="[
              'p-5 text-left rounded-2xl border-2 font-black transition-all flex items-center gap-4 option-btn btn-press',
              getOptionClass(idx)
            ]"
          >
            <span class="w-8 h-8 rounded-lg flex items-center justify-center text-sm" :class="selectedIdx === idx ? 'bg-indigo-200 text-indigo-700' : 'bg-slate-100 text-slate-400'">
              {{ String.fromCharCode(65 + idx) }}
            </span>
            <span class="text-lg">{{ opt }}</span>
          </button>
        </div>

        <button 
          v-if="selectedIdx !== null && !hasValidated" 
          @click="submitAndNext"
          class="btn-press w-full py-5 bg-indigo-600 text-white rounded-2xl font-bold text-xl shadow-xl hover:bg-indigo-700 transition-all"
        >
          Valider ma r√©ponse
        </button>

        <div v-if="hasValidated" class="text-center p-6 text-indigo-500 font-black animate-pulse flex flex-col items-center gap-2">
          <i data-lucide="check-circle" class="w-6 h-6"></i>
          R√©ponse enregistr√©e
        </div>

        <!-- Admin Controls -->
        <div v-if="role === 'admin'" class="mt-10 p-5 bg-slate-900 text-white rounded-2rem flex justify-between items-center shadow-lg">
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-indigo-500 animate-ping"></span>
            <span class="text-[10px] uppercase font-black">Pr√™ts ({{ playersFinishedBlock }}/{{ players.length }})</span>
          </div>
          <button 
            @click="nextStep" 
            class="px-5 py-2 bg-indigo-600 rounded-xl text-[10px] font-black uppercase hover:bg-indigo-500"
          >
            Forcer Suite
          </button>
        </div>
      </div>

      <!-- CRAN D'ATTENTE Fin de bloc -->
      <div v-else-if="isWaitingForBlock && session.status === 'playing'" class="p-12 text-center animate-pop">
        <div class="w-20 h-20 bg-indigo-50 rounded-2rem flex items-center justify-center mx-auto mb-8 animate-pulse shadow-inner">
          <i data-lucide="hourglass" class="w-10 h-10 text-indigo-400"></i>
        </div>
        <h2 class="text-3xl font-black mb-4">Bloc termin√© !</h2>
        <p class="text-slate-500 mb-10">Attends les autres joueurs pour voir le classement...</p>

        <div class="bg-slate-50 p-8 rounded-[2.5rem] border-2 border-slate-100 mb-10 shadow-sm">
          <div class="text-[10px] uppercase font-black text-slate-400 mb-2">Progression du groupe</div>
          <div class="flex items-center justify-center gap-3 font-black text-4xl text-slate-700">
            {{ playersFinishedBlock }}<span class="text-slate-200">/</span>{{ players.length }}
          </div>
        </div>

        <button 
          v-if="role === 'admin'" 
          @click="nextStep" 
          class="btn-press w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-xl shadow-lg"
        >
          Voir le Classement
        </button>
      </div>

      <!-- 5. CLASSEMENT INTERM√âDIAIRE -->
      <div v-else-if="session && session.status === 'checkpoint'" class="p-8 text-center animate-pop">
        <h2 class="text-3xl font-black mb-10 text-slate-900 flex items-center justify-center gap-3">
          <i data-lucide="bar-chart-2" class="text-indigo-600"></i>
          Classement
        </h2>

        <!-- Podium Top 3 -->
        <div class="flex items-end justify-center gap-2 mb-10 min-h-[160px]">
          <!-- 3√®me -->
          <div v-if="sortedPlayers[2]" class="flex flex-col items-center">
            <div :class="getPlayerColor(sortedPlayers[2].name)" class="w-10 h-10 rounded-full border-4 border-white shadow-md flex items-center justify-center text-white font-black uppercase">
              {{ sortedPlayers[2].name.charAt(0) }}
            </div>
            <div class="bg-orange-200 w-14 h-8 rounded-t-xl mt-2 flex items-center justify-center font-black text-orange-600">3</div>
            <span class="text-[10px] font-bold mt-1 truncate w-14">{{ sortedPlayers[2].name }}</span>
          </div>

          <!-- 1er -->
          <div v-if="sortedPlayers[0]" class="flex flex-col items-center">
            <i data-lucide="crown" class="w-6 h-6 text-yellow-500 mb-1"></i>
            <div :class="getPlayerColor(sortedPlayers[0].name)" class="w-16 h-16 rounded-full border-4 border-white shadow-lg flex items-center justify-center text-white text-xl font-black uppercase">
              {{ sortedPlayers[0].name.charAt(0) }}
            </div>
            <div class="bg-yellow-400 w-20 h-20 rounded-t-xl mt-2 flex items-center justify-center font-black text-yellow-800 text-2xl">1</div>
            <span class="text-xs font-black mt-1 truncate w-20">{{ sortedPlayers[0].name }}</span>
          </div>

          <!-- 2√®me -->
          <div v-if="sortedPlayers[1]" class="flex flex-col items-center">
            <div :class="getPlayerColor(sortedPlayers[1].name)" class="w-12 h-12 rounded-full border-4 border-white shadow-md flex items-center justify-center text-white font-black uppercase">
              {{ sortedPlayers[1].name.charAt(0) }}
            </div>
            <div class="bg-slate-200 w-16 h-12 rounded-t-xl mt-2 flex items-center justify-center font-black text-slate-500">2</div>
            <span class="text-[10px] font-bold mt-1 truncate w-16">{{ sortedPlayers[1].name }}</span>
          </div>
        </div>

        <!-- Liste scrollable pour le reste -->
        <div class="bg-slate-50 rounded-3xl p-4 border border-slate-100 max-h-48 overflow-y-auto custom-scrollbar mb-10">
          <div 
            v-for="(p, i) in sortedPlayers" 
            :key="p.id" 
            class="flex items-center p-3 mb-2 rounded-xl border" 
            :class="[
              p.id === userId ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-white border-slate-100'
            ]"
          >
            <span class="w-6 font-black text-xs">{{ i + 1 }}.</span>
            <div :class="getPlayerColor(p.name)" class="w-6 h-6 rounded-full mx-2 flex items-center justify-center text-white text-[10px] font-black uppercase shadow-inner">
              {{ p.name.charAt(0) }}
            </div>
            <span class="flex-grow text-left font-bold truncate">{{ p.name }}</span>
            <span class="font-black text-sm">{{ p.score }} pts</span>
          </div>
        </div>

        <button 
          v-if="role === 'admin'" 
          @click="resumeQuiz" 
          class="btn-press w-full py-6 bg-indigo-600 text-white rounded-2rem font-black text-2xl shadow-xl hover:bg-indigo-700"
        >
          Bloc suivant <i data-lucide="chevrons-right" class="w-6 h-6 inline"></i>
        </button>
      </div>

      <!-- 6. R√âSULTATS FINAUX -->
      <div v-else-if="session && session.status === 'results'" class="p-10 text-center animate-pop">
        <h2 class="text-4xl font-black mb-10 text-slate-900">üèÜ PODIUM FINAL</h2>

        <div class="space-y-4 mb-14">
          <div 
            v-for="(p, i) in sortedPlayers.slice(0, 3)" 
            :key="p.id" 
            class="flex items-center p-6 rounded-[2.5rem] shadow-xl border-4" 
            :class="[
              i === 0 ? 'bg-slate-900 text-white border-yellow-400 scale-105' : 
              p.id === userId ? 'ring-4 ring-indigo-200' : 'bg-white border-slate-50'
            ]"
          >
            <span class="text-4xl mr-6" :class="[i === 0 ? 'text-yellow-400' : 'text-slate-400']">{{ ['ü•á', 'ü•à', 'ü•â'][i] }}</span>
            <div class="flex-grow text-left">
              <div class="text-[10px] font-black uppercase tracking-widest" :class="i === 0 ? 'text-yellow-400' : 'text-slate-400'">
                {{ i === 0 ? 'Gagnant' : i === 1 ? 'Deuxi√®me' : 'Troisi√®me' }}
              </div>
              <div class="text-2xl font-black truncate">{{ p.name }}</div>
            </div>
            <div class="text-right">
              <div class="text-3xl font-black">{{ p.score }}</div>
              <div class="text-[10px] font-black uppercase text-slate-500">pts</div>
            </div>
          </div>
        </div>

        <button 
          @click="resetAll" 
          class="text-slate-400 font-black uppercase text-xs flex items-center gap-3 mx-auto hover:text-indigo-500 transition-colors"
        >
          <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
          Recommencer une session
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- CONFIGURATION FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyA06lwfBciF8K-mU-7OaW-1zkOFJVN3rtc",
      authDomain: "quiz-famille-4d872.firebaseapp.com",
      projectId: "quiz-famille-4d872",
      storageBucket: "quiz-famille-4d872.firebasestorage.app",
      messagingSenderId: "727437618700",
      appId: "1:727437618700:web:0473b0a26958cb08550829"
    };
    
    const appId = 'famille-quiz-4d872';

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { 
      getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, deleteDoc 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);
    const auth = getAuth(firebaseApp);

    // Vue App
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    const ALL_QUESTIONS = [
      // ... tes 100+ questions (je garde la structure, ajoute-les ici)
      { question: "Quelle est la capitale de l'Australie ?", options: ["Sydney", "Melbourne", "Canberra", "Perth"], answer: 2 },
      { question: "Compl√©tez la suite : 1, 3, 6, 10, ... ?", options: ["12", "15", "18", "21"], answer: 1 },
      // Ajoute toutes tes questions ici...
    ];

    createApp({
      setup() {
        const loading = ref(true);
        const userId = ref(null);
        const role = ref(null);
        const name = ref('');
        const sessionId = ref('');
        const tempName = ref('');
        const tempId = ref('');
        const errorMessage = ref('');
        const session = ref(null);
        const players = ref([]);
        const nameInput = ref(null);
        const playerLocalIndex = ref(0);
        const selectedIdx = ref(null);
        const hasValidated = ref(false);

        onMounted(async () => {
          try {
            const cred = await signInAnonymously(auth);
            userId.value = cred.user.uid;

            // R√©cup√©ration de l'ID session depuis l'URL ou le LocalStorage
            const urlParams = new URLSearchParams(window.location.search);
            const joinId = urlParams.get('join');
            const savedSessionId = localStorage.getItem('quiz_session_id');
            const savedRole = localStorage.getItem('quiz_role');
            const savedName = localStorage.getItem('quiz_name');

            if (joinId) {
              tempId.value = joinId.toUpperCase();
              nextTick(() => {
                if (nameInput.value) nameInput.value.focus();
              });
            } else if (savedSessionId && savedRole && savedName) {
              // Reconnexion automatique si les donn√©es existent
              sessionId.value = savedSessionId;
              role.value = savedRole;
              name.value = savedName;
              watchSession(savedSessionId);
            }
          } catch (e) {
            console.error(e);
          } finally {
            loading.value = false;
            nextTick(() => lucide.createIcons());
          }
        });

        const getPlayerColor = (playerName) => {
          const colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-orange-500'];
          let hash = 0;
          for (let i = 0; i < playerName.length; i++) {
            hash = playerName.charCodeAt(i) + ((hash << 5) - hash);
          }
          return colors[Math.abs(hash) % colors.length];
        };

        const isImageUrl = (str) => {
          if (!str) return false;
          return str.startsWith('http') || str.startsWith('https') || str.startsWith('data:');
        };

        const getOptionClass = (idx) => {
          if (!hasValidated.value) {
            return selectedIdx.value === idx ? 
              'border-indigo-600 bg-indigo-50 shadow-md' : 
              'border-slate-100 hover:border-indigo-300';
          }

          const q = session.value?.questions?.[playerLocalIndex.value];
          if (idx === q.answer) {
            return 'border-green-500 bg-green-50 text-green-700 shadow-sm';
          }
          if (selectedIdx.value === idx && idx !== q.answer) {
            return 'border-red-500 bg-red-50 text-red-700 opacity-80';
          }
          return 'border-slate-100 bg-slate-50 opacity-40 grayscale';
        };

        const generateQR = (id) => {
          nextTick(() => {
            const qrEl = document.getElementById('qrcode');
            if (qrEl) {
              qrEl.innerHTML = '';
              const url = `${window.location.origin}${window.location.pathname}?join=${id}`;
              setTimeout(() => {
                new QRCode(qrEl, {
                  text: url,
                  width: 128,
                  height: 128,
                  colorDark: "#4f46e5",
                  colorLight: "#ffffff",
                  correctLevel: QRCode.CorrectLevel.H
                });
              }, 50);
            }
          });
        };

        const getRandomQuestions = () => {
          let used = JSON.parse(localStorage.getItem('quiz_memory') || '[]');
          let available = ALL_QUESTIONS.map((q, i) => i).filter(idx => !used.includes(idx));
          
          if (available.length < 15) {
            used = [];
            available = ALL_QUESTIONS.map((_, i) => i);
          }
          
          const selectedIndices = available.sort(() => 0.5 - Math.random()).slice(0, 15);
          localStorage.setItem('quiz_memory', JSON.stringify([...used, ...selectedIndices]));
          
          return selectedIndices.map(idx => ALL_QUESTIONS[idx]);
        };

        const initAdmin = async () => {
          if (!tempName.value) return;

          const id = Math.random().toString(36).substring(2, 6).toUpperCase();
          const selectedQs = getRandomQuestions();

          const sRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id);
          await setDoc(sRef, {
            id,
            status: 'lobby',
            currentBlock: 0,
            adminId: userId.value,
            adminName: tempName.value,
            questions: selectedQs
          });

          const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id, 'players', userId.value);
          await setDoc(pRef, {
            name: tempName.value,
            score: 0,
            localIndex: 0,
            finishedBlock: false
          });

          name.value = tempName.value;
          sessionId.value = id;
          role.value = 'admin';
          
          localStorage.setItem('quiz_session_id', id);
          localStorage.setItem('quiz_role', 'admin');
          localStorage.setItem('quiz_name', tempName.value);
          
          watchSession(id);
        };

        const joinGame = async () => {
          errorMessage.value = '';
          if (!tempName.value || !tempId.value) return;

          const id = tempId.value.toUpperCase();
          const sRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id);
          const snap = await getDoc(sRef);

          if (snap.exists()) {
            const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id, 'players', userId.value);
            const pSnap = await getDoc(pRef);

            if (!pSnap.exists()) {
              await setDoc(pRef, {
                name: tempName.value,
                score: 0,
                localIndex: 0,
                finishedBlock: false
              });
            }

            name.value = tempName.value;
            sessionId.value = id;
            role.value = 'player';
            
            localStorage.setItem('quiz_session_id', id);
            localStorage.setItem('quiz_role', 'player');
            localStorage.setItem('quiz_name', tempName.value);
            
            watchSession(id);
          } else {
            errorMessage.value = 'Code de session introuvable...';
          }
        };

        // ‚úÖ FONCTION CORRIG√âE : D√©tecte suppression/Fin de session
        const watchSession = (id) => {
          const unsubSession = onSnapshot(
            doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id),
            (s) => {
              // ‚úÖ NOUVEAU : Si la session n'existe plus (supprim√©e par admin)
              if (!s.exists()) {
                console.log('Session supprim√©e, retour √† l\'accueil');
                // Reset complet pour retour √† l'accueil
                session.value = null;
                role.value = null;
                sessionId.value = null;
                players.value = [];
                playerLocalIndex.value = 0;
                selectedIdx.value = null;
                hasValidated.value = false;
                localStorage.removeItem('quiz_session_id');
                localStorage.removeItem('quiz_role');
                localStorage.removeItem('quiz_name');
                return;
              }

              const data = s.data();
              session.value = data;

              // ‚úÖ Gestion fin de partie (results) - optionnel : reset direct ou laisser voir podium
              if (data.status === 'results') {
                // Option 1 : Laisser voir le podium final puis retour auto apr√®s 10s
                setTimeout(() => {
                  if (session.value?.status === 'results') {
                    resetAll();
                  }
                }, 10000);
              }

              if (data.status === 'lobby') {
                generateQR(id);
                nextTick(() => lucide.createIcons());
              }

              // Watch players
              const unsubPlayers = onSnapshot(
                collection(db, 'artifacts', appId, 'public', 'data', 'sessions', id, 'players'),
                (s) => {
                  players.value = s.docs.map(d => ({ id: d.id, ...d.data() }));

                  // RECONNAISSANCE DU JOUEUR ET R√âCUP√âRATION DE L'INDEX
                  const me = players.value.find(p => p.id === userId.value);
                  if (me && me.localIndex !== undefined) {
                    // On ne met √† jour que si on a rafra√Æchi (index local = 0) ou si la valeur en base est plus avanc√©e (s√©curit√©)
                    if (playerLocalIndex.value === 0 || me.localIndex > playerLocalIndex.value) {
                      playerLocalIndex.value = me.localIndex;
                    }
                  }
                }
              );

              return () => unsubPlayers();
            },
            (error) => {
              console.error('Erreur watchSession:', error);
              // En cas d'erreur r√©seau, reset aussi
              session.value = null;
              role.value = null;
            }
          );

          return unsubSession;
        };

        const submitAndNext = async () => {
          if (selectedIdx.value === null) return;
          hasValidated.value = true;

          const q = session.value.questions[playerLocalIndex.value];
          const isCorrect = selectedIdx.value === q.answer;

          setTimeout(async () => {
            const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId.value, 'players', userId.value);
            const pSnap = await getDoc(pRef);
            const scoreNow = (pSnap.data()?.score || 0);

            const nextIdx = playerLocalIndex.value + 1;
            const isFinished = nextIdx >= (session.value.currentBlock + 1) * 5;

            await updateDoc(pRef, {
              score: isCorrect ? scoreNow + 1 : scoreNow,
              localIndex: nextIdx,
              finishedBlock: isFinished
            });

            // On met √† jour localement pour l'affichage imm√©diat
            playerLocalIndex.value = nextIdx;
            selectedIdx.value = null;
            hasValidated.value = false;
          }, 2000);
        };

        const nextStep = async () => {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId.value), {
            status: 'checkpoint'
          });
        };

        const resumeQuiz = async () => {
          const nextBlock = session.value.currentBlock + 1;
          const sRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId.value);

          if (nextBlock * 5 >= 15) {
            // Fin du quiz
            await updateDoc(sRef, { status: 'results' });
          } else {
            // Reset finishedBlock pour tout le monde
            for (const p of players.value) {
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId.value, 'players', p.id), {
                finishedBlock: false
              });
            }
            await updateDoc(sRef, {
              currentBlock: nextBlock,
              status: 'playing'
            });
          }
        };

        // ‚úÖ FONCTION CORRIG√âE : Supprime la session Firestore pour tous les joueurs
        const resetAll = async () => {
          if (role.value === 'admin' && sessionId.value) {
            try {
              // Supprime la session -> d√©clenche watchSession(!s.exists()) chez TOUS les joueurs
              await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId.value));
              console.log('Session supprim√©e par admin');
            } catch (e) {
              console.error('Erreur suppression session:', e);
            }
          }

          // Nettoyage local
          localStorage.removeItem('quiz_session_id');
          localStorage.removeItem('quiz_role');
          localStorage.removeItem('quiz_name');
          
          // Reset √©tat Vue (redondant mais s√ªr)
          session.value = null;
          role.value = null;
          sessionId.value = null;
          players.value = [];
          playerLocalIndex.value = 0;
          selectedIdx.value = null;
          hasValidated.value = false;

          // Recharge optionnel (laisser Vue g√©rer normalement)
          // window.location.reload();
        };

        const updateStatus = (status) => {
          updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId.value), {
            status
          });
        };

        return {
          loading, role, name, sessionId, tempName, tempId, session, players, userId, errorMessage,
          nameInput, playerLocalIndex, selectedIdx, hasValidated,
          isImageUrl, getPlayerColor, getOptionClass, currentQuestion: computed(() => 
            session.value?.questions?.[playerLocalIndex.value]?.question || ''
          ),
          isWaitingForBlock: computed(() => 
            playerLocalIndex.value >= (session.value?.currentBlock + 1) * 5
          ),
          playersFinishedBlock: computed(() => 
            players.value.filter(p => p.finishedBlock).length
          ),
          sortedPlayers: computed(() => 
            [...players.value].sort((a, b) => b.score - a.score)
          ),
          initAdmin, joinGame, submitAndNext, nextStep, resumeQuiz, resetAll, updateStatus
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
